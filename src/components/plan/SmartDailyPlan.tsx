/**
 * SmartDailyPlan Component
 *
 * AI-powered daily plan component that displays focus blocks, quick wins,
 * meetings, and defer suggestions generated by the AI.
 *
 * Requirements: 1.6, 1.7, 6.4
 */

import { useDailyPlan } from "../../hooks/useDailyPlan";
import type { PlanTask } from "../../services/backend/plan";
import "./DailyPlan.css";

interface SmartDailyPlanProps {
  onTaskComplete?: (taskId: string) => void;
  onTaskCreate?: (title: string) => void;
}

export function SmartDailyPlan({
  onTaskComplete,
  // onTaskCreate is available for future use when QuickTaskInput is integrated
  onTaskCreate: _onTaskCreate,
}: SmartDailyPlanProps) {
  void _onTaskCreate; // Suppress unused variable warning
  const { plan, isLoading, isGenerating, error, regenerate } = useDailyPlan();

  const getGreeting = () => {
    const hour = new Date().getHours();
    if (hour < 12) return "Good morning";
    if (hour < 18) return "Good afternoon";
    return "Good evening";
  };

  const formatSuggestedTime = (time?: string) => {
    if (!time) return null;
    try {
      const date = new Date(time);
      return date.toLocaleTimeString("en-US", {
        hour: "numeric",
        minute: "2-digit",
        hour12: true,
      });
    } catch {
      return time;
    }
  };

  const getPriorityColor = (priority: PlanTask["priority"]) => {
    switch (priority) {
      case "high":
        return "var(--color-error, #ef4444)";
      case "medium":
        return "var(--color-warning, #f59e0b)";
      case "low":
        return "var(--color-success, #22c55e)";
      default:
        return "var(--color-text-secondary)";
    }
  };

  const getTypeIcon = (type: PlanTask["type"]) => {
    switch (type) {
      case "focus":
        return "ğŸ¯";
      case "task":
        return "âœ…";
      case "email":
        return "ğŸ“§";
      case "meeting":
        return "ğŸ“…";
      case "break":
        return "â˜•";
      default:
        return "ğŸ“‹";
    }
  };

  if (isLoading) {
    return (
      <div className="daily-plan loading">
        <div className="loading-spinner" />
        <p>Loading your AI-powered plan...</p>
      </div>
    );
  }

  if (error && !plan) {
    return (
      <div className="daily-plan error">
        <p>{error}</p>
        <button onClick={regenerate}>Generate Plan</button>
      </div>
    );
  }

  return (
    <div className="daily-plan">
      <header className="plan-header titlebar-drag-region">
        <div className="greeting no-drag">
          <h1>{getGreeting()}</h1>
          <p className="date">
            {new Date().toLocaleDateString("en-US", {
              weekday: "long",
              month: "long",
              day: "numeric",
            })}
          </p>
        </div>
        <button
          className="refresh-btn no-drag"
          onClick={regenerate}
          disabled={isGenerating}
          title={isGenerating ? "Generating..." : "Regenerate plan"}
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            className={isGenerating ? "spinning" : ""}
          >
            <path d="M21 12a9 9 0 11-2.2-5.9M21 4v4h-4" />
          </svg>
        </button>
      </header>

      <main className="plan-content">
        {/* Summary and Energy Tip */}
        {plan && (plan.summary || plan.energy_tip) && (
          <section className="plan-block glass summary-block">
            {plan.summary && (
              <p className="plan-summary">{plan.summary}</p>
            )}
            {plan.energy_tip && (
              <p className="energy-tip">
                <span className="tip-icon">ğŸ’¡</span>
                {plan.energy_tip}
              </p>
            )}
          </section>
        )}

        {/* Focus Blocks */}
        <section className="plan-block glass">
          <h2 className="block-title">
            <span className="block-icon">ğŸ¯</span>
            Focus Blocks
          </h2>
          {!plan || plan.focus_blocks.length === 0 ? (
            <p className="empty-state">No focus blocks scheduled</p>
          ) : (
            <ul className="task-list">
              {plan.focus_blocks.map((task) => (
                <PlanTaskItem
                  key={task.id}
                  task={task}
                  onComplete={onTaskComplete}
                  formatTime={formatSuggestedTime}
                  getPriorityColor={getPriorityColor}
                  getTypeIcon={getTypeIcon}
                />
              ))}
            </ul>
          )}
        </section>

        {/* Quick Wins */}
        <section className="plan-block glass">
          <h2 className="block-title">
            <span className="block-icon">âš¡</span>
            Quick Wins
          </h2>
          {!plan || plan.quick_wins.length === 0 ? (
            <p className="empty-state">No quick wins available</p>
          ) : (
            <ul className="task-list">
              {plan.quick_wins.map((task) => (
                <PlanTaskItem
                  key={task.id}
                  task={task}
                  onComplete={onTaskComplete}
                  formatTime={formatSuggestedTime}
                  getPriorityColor={getPriorityColor}
                  getTypeIcon={getTypeIcon}
                />
              ))}
            </ul>
          )}
        </section>

        {/* Meetings */}
        <section className="plan-block glass">
          <h2 className="block-title">
            <span className="block-icon">ğŸ“…</span>
            Meetings
          </h2>
          {!plan || plan.meetings.length === 0 ? (
            <p className="empty-state">No meetings scheduled</p>
          ) : (
            <ul className="event-list">
              {plan.meetings.map((meeting) => (
                <MeetingItem
                  key={meeting.id}
                  meeting={meeting}
                  formatTime={formatSuggestedTime}
                />
              ))}
            </ul>
          )}
        </section>

        {/* Defer Suggestions */}
        {plan && plan.defer_suggestions.length > 0 && (
          <section className="plan-block glass defer-block">
            <h2 className="block-title">
              <span className="block-icon">ğŸ“Œ</span>
              Consider Deferring
            </h2>
            <ul className="defer-list">
              {plan.defer_suggestions.map((suggestion, index) => (
                <li key={index} className="defer-item">
                  {suggestion}
                </li>
              ))}
            </ul>
          </section>
        )}

        {/* No Plan State */}
        {!plan && !error && (
          <section className="plan-block glass">
            <div className="no-plan-state">
              <p>No plan generated yet for today.</p>
              <button
                className="generate-btn"
                onClick={regenerate}
                disabled={isGenerating}
              >
                {isGenerating ? "Generating..." : "Generate AI Plan"}
              </button>
            </div>
          </section>
        )}
      </main>
    </div>
  );
}


/**
 * Individual plan task item component
 */
interface PlanTaskItemProps {
  task: PlanTask;
  onComplete?: (taskId: string) => void;
  formatTime: (time?: string) => string | null;
  getPriorityColor: (priority: PlanTask["priority"]) => string;
  getTypeIcon: (type: PlanTask["type"]) => string;
}

function PlanTaskItem({
  task,
  onComplete,
  formatTime,
  getPriorityColor,
  getTypeIcon,
}: PlanTaskItemProps) {
  const handleComplete = () => {
    if (task.source_id && onComplete) {
      onComplete(task.source_id);
    }
  };

  return (
    <li className="task-item plan-task-item">
      {task.source_type === "task" && (
        <input
          type="checkbox"
          className="task-checkbox"
          onChange={handleComplete}
          title="Mark as complete"
        />
      )}
      <div className="task-content">
        <div className="task-header">
          <span className="task-type-icon">{getTypeIcon(task.type)}</span>
          <span className="task-title">{task.title}</span>
          <span
            className="task-priority"
            style={{ color: getPriorityColor(task.priority) }}
          >
            {task.priority}
          </span>
        </div>
        <div className="task-meta">
          {task.suggested_time && (
            <span className="suggested-time">
              ğŸ• {formatTime(task.suggested_time)}
            </span>
          )}
          {task.duration_minutes > 0 && (
            <span className="task-duration">
              â±ï¸ {task.duration_minutes}min
            </span>
          )}
        </div>
        {task.context && (
          <p className="task-context">{task.context}</p>
        )}
      </div>
    </li>
  );
}

/**
 * Meeting item component
 */
interface MeetingItemProps {
  meeting: PlanTask;
  formatTime: (time?: string) => string | null;
}

function MeetingItem({ meeting, formatTime }: MeetingItemProps) {
  const isStartingSoon = () => {
    if (!meeting.suggested_time) return false;
    try {
      const meetingTime = new Date(meeting.suggested_time);
      const now = new Date();
      const diffMinutes = (meetingTime.getTime() - now.getTime()) / (1000 * 60);
      return diffMinutes >= 0 && diffMinutes <= 15;
    } catch {
      return false;
    }
  };

  return (
    <li className={`event-item ${isStartingSoon() ? "starting-soon" : ""}`}>
      <div className="event-time">
        {formatTime(meeting.suggested_time) || "TBD"}
      </div>
      <div className="event-details">
        <span className="event-title">{meeting.title}</span>
        {meeting.duration_minutes > 0 && (
          <span className="event-duration">
            {meeting.duration_minutes} minutes
          </span>
        )}
        {meeting.context && (
          <span className="event-location">{meeting.context}</span>
        )}
      </div>
    </li>
  );
}

export default SmartDailyPlan;
